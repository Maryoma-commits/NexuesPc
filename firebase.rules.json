{
  "rules": {
    ".read": "auth != null",
    ".write": false,

    "users": {
      "$uid": {
        ".read": "auth != null && (auth.uid === $uid || auth.token.admin === true)",
        ".write": "auth != null && auth.uid === $uid",
        "provider": { ".validate": "newData.val() === data.val() || newData.val() === 'google' || newData.val() === 'email'" }
      }
    },

    "bannedUsers": {
      "$uid": {
        ".read": "auth != null && auth.token.admin === true",
        ".write": "auth != null && auth.token.admin === true"
      }
    },
    "bannedIPs": {
      "$ip": {
        ".read": "auth != null && auth.token.admin === true",
        ".write": "auth != null && auth.token.admin === true"
      }
    },

    "viewingStatus": {
      "$uid": {
        ".read": "auth != null",
        "globalChat": { ".write": "auth != null && auth.uid === $uid" },
        "dmConversation": { ".write": "auth != null && auth.uid === $uid" }
      }
    },

    "globalChat": {
      "messages": {
        ".indexOn": ["timestamp"],
        "$msgId": {
          ".read": "auth != null",
          ".write": "auth != null && ((auth.token.admin === true) || ((!data.exists() && newData.child('senderId').val() === auth.uid) || (data.exists() && data.child('senderId').val() === auth.uid)))",
          "senderId": { ".validate": "newData.val() === data.val() || (!data.exists() && newData.val() === auth.uid)" },
          "timestamp": { ".validate": "newData.isNumber()" },
          "text": { ".validate": "newData.val() === null || (newData.isString() && newData.val().length > 0 && newData.val().length <= 2000)" },
          "imageUrl": { ".validate": "newData.val() === null || newData.isString()" },
          "edited": { ".validate": "newData.val() === true || newData.val() === null" },
          "editedAt": { ".validate": "newData.isNumber() || newData.val() === null" },
          "seenBy": {
            "$uid": {
              ".write": "auth != null && auth.uid === $uid",
              ".validate": "newData.isNumber()"
            }
          },
          "reactions": { ".validate": "newData.val() === null || newData.hasChildren()" }
        }
      },
      "typing": {
        "$uid": {
          ".write": "auth != null && auth.uid === $uid",
          ".validate": "newData.hasChildren(['userId','displayName','timestamp']) && newData.child('userId').val() === auth.uid && newData.child('timestamp').isNumber() && newData.child('displayName').isString()"
        }
      }
    },

    "directMessages": {
      "$convId": {
        "messages": {
          ".indexOn": ["timestamp"],
          "$msgId": {
            ".read": "auth != null",
            ".write": "auth != null && ((auth.token.admin === true) || ((!data.exists() && newData.child('senderId').val() === auth.uid) || (data.exists() && data.child('senderId').val() === auth.uid)))",
            "senderId": { ".validate": "newData.val() === data.val() || (!data.exists() && newData.val() === auth.uid)" },
            "recipientId": { ".validate": "newData.val() === data.val() || (!data.exists() && newData.isString())" },
            "timestamp": { ".validate": "newData.isNumber()" },
            "text": { ".validate": "newData.val() === null || (newData.isString() && newData.val().length > 0 && newData.val().length <= 2000)" },
            "imageUrl": { ".validate": "newData.val() === null || newData.isString()" },
            "edited": { ".validate": "newData.val() === true || newData.val() === null" },
            "editedAt": { ".validate": "newData.isNumber() || newData.val() === null" },
            "reactions": { ".validate": "newData.val() === null || newData.hasChildren()" }
          }
        },
        "typing": {
          "$uid": {
            ".write": "auth != null && auth.uid === $uid",
            ".validate": "newData.hasChildren(['userId','displayName','timestamp']) && newData.child('userId').val() === auth.uid && newData.child('timestamp').isNumber()"
          }
        }
      }
    },

    "conversations": {
      "$convId": {
        ".read": "auth != null",
        ".write": "auth != null",
        "unreadCount": {
          "$uid": { ".write": "auth != null && auth.uid === $uid", ".validate": "newData.isNumber()" }
        },
        "lastReadTimestamp": {
          "$uid": { ".write": "auth != null && auth.uid === $uid", ".validate": "newData.isNumber()" }
        }
      }
    },

    "notifications": {
      "$uid": {
        ".read": "auth != null && auth.uid === $uid",
        "$notifId": {
          "read": { ".write": "auth != null && auth.uid === $uid" }
        }
      }
    },

    "reports": {
      "$messageId": {
        ".write": "auth != null",
        ".read": "auth != null && auth.token.admin === true"
      }
    },

    "ipTracking": {
      "$ip": {
        "$uid": {
          ".write": "auth != null && auth.uid === $uid",
          ".read": "auth != null && auth.token.admin === true"
        }
      }
    },

    "friends": {
      "$uid": {
        ".read": "auth != null && auth.uid === $uid",
        "$friendId": { ".write": "auth != null && (auth.uid === $uid || auth.uid === $friendId)" }
      }
    },

    "friendRequests": {
      "$toUid": {
        ".read": "auth != null && auth.uid === $toUid",
        "$reqId": {
          ".write": "auth != null && ((!data.exists() && newData.child('from').val() === auth.uid) || (data.exists() && auth.uid === $toUid))"
        }
      }
    }
  }
}
