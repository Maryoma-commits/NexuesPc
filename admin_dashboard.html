<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>NexusPC Admin Dashboard</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
        }
        
        .container {
            max-width: 1200px;
            margin: 0 auto;
            background: white;
            border-radius: 15px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.2);
            overflow: hidden;
        }
        
        .header {
            background: linear-gradient(135deg, #4facfe 0%, #00f2fe 100%);
            padding: 30px;
            text-align: center;
            color: white;
        }
        
        .header h1 {
            font-size: 2.5em;
            margin-bottom: 10px;
        }
        
        .header p {
            font-size: 1.1em;
            opacity: 0.9;
        }
        
        .nav-tabs {
            display: flex;
            background: #f8f9fa;
            border-bottom: 1px solid #dee2e6;
        }
        
        .tab {
            flex: 1;
            padding: 15px 20px;
            text-align: center;
            cursor: pointer;
            border: none;
            background: none;
            font-size: 16px;
            transition: all 0.3s ease;
        }
        
        .tab:hover {
            background: #e9ecef;
        }
        
        .tab.active {
            background: white;
            border-bottom: 3px solid #4facfe;
            color: #4facfe;
            font-weight: 600;
        }
        
        .content {
            padding: 30px;
        }
        
        .tab-content {
            display: none;
        }
        
        .tab-content.active {
            display: block;
        }
        
        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }
        
        .stat-card {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 25px;
            border-radius: 10px;
            text-align: center;
        }
        
        .stat-card h3 {
            font-size: 2.5em;
            margin-bottom: 10px;
        }
        
        .stat-card p {
            font-size: 1.1em;
            opacity: 0.9;
        }
        
        .control-panel {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }
        
        .control-group {
            background: #f8f9fa;
            padding: 25px;
            border-radius: 10px;
            border-left: 4px solid #4facfe;
        }
        
        .control-group h4 {
            margin-bottom: 15px;
            color: #333;
        }
        
        .btn {
            padding: 12px 24px;
            margin: 5px;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            font-size: 14px;
            transition: all 0.3s ease;
            text-decoration: none;
            display: inline-block;
        }
        
        .btn-primary {
            background: linear-gradient(135deg, #4facfe 0%, #00f2fe 100%);
            color: white;
        }
        
        .btn-success {
            background: linear-gradient(135deg, #43e97b 0%, #38f9d7 100%);
            color: white;
        }
        
        .btn-warning {
            background: linear-gradient(135deg, #fa709a 0%, #fee140 100%);
            color: white;
        }
        
        .btn-danger {
            background: linear-gradient(135deg, #ff6b6b 0%, #ffa8a8 100%);
            color: white;
        }
        
        .btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(0,0,0,0.2);
        }
        
        .site-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 15px;
            margin-top: 20px;
        }
        
        .site-card {
            background: white;
            border: 1px solid #dee2e6;
            border-radius: 8px;
            padding: 20px;
            text-align: center;
            transition: all 0.3s ease;
        }
        
        .site-card:hover {
            box-shadow: 0 5px 15px rgba(0,0,0,0.1);
            transform: translateY(-2px);
        }
        
        .site-logo {
            width: 60px;
            height: 60px;
            margin: 0 auto 15px;
            background: #f8f9fa;
            border-radius: 10px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 20px;
            font-weight: bold;
            color: #667eea;
            padding: 8px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
            transition: all 0.3s ease;
        }
        
        .site-logo img {
            width: 100%;
            height: 100%;
            object-fit: contain;
            border-radius: 6px;
        }
        
        .site-logo:hover {
            transform: scale(1.05);
            box-shadow: 0 4px 15px rgba(0,0,0,0.2);
        }
        
        .log-area {
            background: #1e1e1e;
            color: #00ff00;
            padding: 20px;
            border-radius: 8px;
            font-family: 'Courier New', monospace;
            height: 400px;
            overflow-y: auto;
            margin-top: 20px;
        }
        
        .status-indicator {
            width: 12px;
            height: 12px;
            border-radius: 50%;
            display: inline-block;
            margin-right: 8px;
        }
        
        .status-online { background: #28a745; }
        .status-offline { background: #dc3545; }
        .status-warning { background: #ffc107; }
        
        .progress-bar {
            width: 100%;
            height: 6px;
            background: #e9ecef;
            border-radius: 3px;
            overflow: hidden;
            margin-top: 10px;
        }
        
        .progress-fill {
            height: 100%;
            background: linear-gradient(90deg, #4facfe, #00f2fe);
            width: 0%;
            transition: width 0.3s ease;
        }
        
        .editor-section {
            background: #f8f9fa;
            padding: 20px;
            border-radius: 8px;
            margin-top: 20px;
        }
        
        .form-group {
            margin-bottom: 15px;
        }
        
        label {
            display: block;
            margin-bottom: 5px;
            font-weight: 600;
        }
        
        input, select, textarea {
            width: 100%;
            padding: 10px;
            border: 1px solid #ddd;
            border-radius: 5px;
            font-size: 14px;
        }
        
        textarea {
            height: 100px;
            resize: vertical;
        }
        
        .hidden {
            display: none;
        }
        
        /* Visual Product Editor Styles */
        .visual-editor-container {
            padding: 0;
        }
        
        .editor-controls {
            background: #f8f9fa;
            padding: 20px;
            border-radius: 8px;
            margin-bottom: 20px;
        }
        
        .control-row {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 15px;
            margin-bottom: 15px;
        }
        
        .status-filters {
            display: flex;
            gap: 10px;
            margin-bottom: 15px;
        }
        
        .status-btn {
            display: flex;
            flex-direction: column;
            align-items: center;
            padding: 10px 15px;
            border: 2px solid #dee2e6;
            border-radius: 8px;
            background: white;
            cursor: pointer;
            transition: all 0.3s ease;
        }
        
        .status-btn:hover {
            border-color: #4facfe;
            background: #f8f9ff;
        }
        
        .status-btn.active {
            border-color: #4facfe;
            background: #4facfe;
            color: white;
        }
        
        .status-btn .count {
            font-weight: bold;
            font-size: 18px;
            margin-top: 5px;
        }
        
        .category-info {
            display: flex;
            flex-wrap: wrap;
            gap: 8px;
        }
        
        .filter-badge {
            background: #667eea;
            color: white;
            padding: 4px 8px;
            border-radius: 12px;
            font-size: 12px;
        }
        
        .product-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(280px, 1fr));
            gap: 20px;
        }
        
        .empty-state {
            grid-column: 1 / -1;
            text-align: center;
            padding: 60px 20px;
            color: #6c757d;
        }
        
        .product-item {
            background: white;
            border: 1px solid #dee2e6;
            border-radius: 8px;
            padding: 15px;
            cursor: pointer;
            transition: all 0.3s ease;
            position: relative;
        }
        
        .product-item:hover {
            box-shadow: 0 5px 15px rgba(0,0,0,0.1);
            transform: translateY(-2px);
        }
        
        .product-item.has-specs {
            border-left: 4px solid #28a745;
        }
        
        .product-item.no-specs {
            border-left: 4px solid #dc3545;
        }
        
        .product-image {
            width: 80px;
            height: 80px;
            object-fit: contain;
            border-radius: 6px;
            background: #f8f9fa;
            padding: 8px;
            margin-bottom: 12px;
            border: 1px solid #dee2e6;
        }
        
        .product-title {
            font-weight: 600;
            font-size: 14px;
            margin-bottom: 8px;
            display: -webkit-box;
            -webkit-line-clamp: 2;
            -webkit-box-orient: vertical;
            overflow: hidden;
        }
        
        .product-price {
            color: #4facfe;
            font-weight: bold;
            margin-bottom: 5px;
        }
        
        .product-store {
            font-size: 12px;
            color: #6c757d;
            margin-bottom: 8px;
        }
        
        .product-status {
            display: flex;
            align-items: center;
            gap: 5px;
            font-size: 12px;
        }
        
        .status-indicator {
            width: 8px;
            height: 8px;
            border-radius: 50%;
        }
        
        .status-complete { background: #28a745; }
        .status-incomplete { background: #dc3545; }
        
        /* Product Modal Styles */
        .product-modal {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.8);
            z-index: 1000;
            display: flex;
            align-items: center;
            justify-content: center;
        }
        
        .modal-content {
            background: white;
            border-radius: 12px;
            width: 90%;
            max-width: 800px;
            max-height: 90%;
            overflow-y: auto;
        }
        
        .modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 20px;
            border-bottom: 1px solid #dee2e6;
        }
        
        .close-btn {
            background: none;
            border: none;
            font-size: 24px;
            cursor: pointer;
            color: #6c757d;
        }
        
        .modal-body {
            padding: 20px;
        }
        
        .product-preview {
            display: flex;
            gap: 20px;
            margin-bottom: 30px;
            padding: 15px;
            background: #f8f9fa;
            border-radius: 8px;
        }
        
        .product-preview img {
            width: 80px;
            height: 80px;
            object-fit: contain;
            border-radius: 4px;
            background: white;
            padding: 5px;
        }
        
        .product-details h4 {
            margin-bottom: 8px;
            color: #333;
        }
        
        .product-details p {
            margin-bottom: 4px;
            color: #6c757d;
        }
        
        .specs-form {
            margin-bottom: 20px;
        }
        
        .spec-field {
            margin-bottom: 15px;
        }
        
        .spec-field label {
            display: block;
            margin-bottom: 5px;
            font-weight: 600;
            color: #333;
        }
        
        .spec-field input,
        .spec-field select {
            width: 100%;
            padding: 8px 12px;
            border: 1px solid #ddd;
            border-radius: 4px;
            font-size: 14px;
        }
        
        .category-change {
            margin-top: 20px;
            padding-top: 20px;
            border-top: 1px solid #dee2e6;
        }
        
        .modal-footer {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 20px;
            border-top: 1px solid #dee2e6;
            background: #f8f9fa;
        }
        
        .navigation-controls {
            display: flex;
            align-items: center;
            gap: 10px;
        }
        
        .navigation-controls span {
            padding: 0 10px;
            color: #6c757d;
            font-size: 14px;
        }
        
        /* Bulk Edit Styles */
        .bulk-actions-toolbar {
            background: #f8f9fa;
            border: 2px solid #4facfe;
            border-radius: 8px;
            padding: 15px;
            margin-bottom: 20px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            flex-wrap: wrap;
            gap: 15px;
        }
        
        .bulk-selection-info {
            display: flex;
            align-items: center;
            gap: 10px;
            font-weight: 600;
            color: #4facfe;
        }
        
        .bulk-actions {
            display: flex;
            gap: 10px;
            flex-wrap: wrap;
        }
        
        .btn-sm {
            padding: 6px 12px;
            font-size: 12px;
        }
        
        .product-item.bulk-mode {
            position: relative;
            border: 2px solid transparent;
            transition: border-color 0.2s ease;
        }
        
        .product-item.bulk-mode:hover {
            border-color: #4facfe;
        }
        
        .product-item.bulk-selected {
            border-color: #4facfe;
            background: #f0f8ff;
        }
        
        .bulk-checkbox {
            position: absolute;
            top: 8px;
            left: 8px;
            width: 20px;
            height: 20px;
            cursor: pointer;
            z-index: 10;
        }
        
        .bulk-overlay {
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(79, 172, 254, 0.1);
            border-radius: 8px;
            opacity: 0;
            transition: opacity 0.2s ease;
        }
        
        .product-item.bulk-selected .bulk-overlay {
            opacity: 1;
        }
        
        /* Bulk Spec Modal */
        .bulk-spec-modal {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.8);
            z-index: 2000;
            display: flex;
            align-items: center;
            justify-content: center;
        }
        
        .bulk-spec-content {
            background: white;
            border-radius: 12px;
            width: 90%;
            max-width: 600px;
            max-height: 80%;
            overflow-y: auto;
        }
        
        .bulk-preview {
            max-height: 200px;
            overflow-y: auto;
            background: #f8f9fa;
            padding: 15px;
            border-radius: 6px;
            margin-bottom: 20px;
        }
        
        .bulk-preview-item {
            padding: 5px 0;
            border-bottom: 1px solid #dee2e6;
            font-size: 14px;
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>üõí NexusPC Admin Dashboard</h1>
            <p>Manage your PC component aggregator with ease</p>
        </div>
        
        <div class="nav-tabs">
            <button class="tab active" onclick="showTab('overview')">üìä Overview</button>
            <button class="tab" onclick="showTab('scraping')">üï∑Ô∏è Scraping</button>
            <button class="tab" onclick="showTab('products')">üì¶ Products</button>
            <button class="tab" onclick="showTab('logs')">üìã Logs</button>
        </div>
        
        <div class="content">
            <!-- Overview Tab -->
            <div id="overview" class="tab-content active">
                <div class="stats-grid">
                    <div class="stat-card">
                        <h3 id="total-products">Loading...</h3>
                        <p>Total Products</p>
                    </div>
                    <div class="stat-card">
                        <h3 id="active-sites">Loading...</h3>
                        <p>Active Retailers</p>
                    </div>
                    <div class="stat-card">
                        <h3 id="last-update">Loading...</h3>
                        <p>Hours Since Update</p>
                    </div>
                    <div class="stat-card">
                        <h3 id="server-status"><span class="status-indicator status-online"></span>Online</h3>
                        <p>Server Status</p>
                    </div>
                </div>
                
                <div class="control-panel">
                    <div class="control-group">
                        <h4>üöÄ Quick Actions</h4>
                        <button class="btn btn-primary" onclick="scrapeAllSites()">Scrape All Sites</button>
                        <button class="btn btn-success" onclick="refreshStatus()">Refresh Status</button>
                        <button class="btn btn-warning" onclick="showLogs()">View Logs</button>
                    </div>
                    
                </div>
            </div>
            
            <!-- Scraping Tab -->
            <div id="scraping" class="tab-content">
                <div class="control-group">
                    <h4>üï∑Ô∏è Scraping Control Center</h4>
                    <button class="btn btn-primary" onclick="scrapeAllSites()">Scrape All Retailers</button>
                    <button class="btn btn-success" onclick="toggleAutoScraping()">Toggle Auto-Scraping</button>
                </div>
                
                <div class="site-grid" id="site-grid">
                    <!-- Site cards will be generated here -->
                </div>
                
                <div class="log-area" id="scraping-log">
                    <div id="log-content">üöÄ NexusPC Scraping Console Ready...\n</div>
                </div>
            </div>
            
            <!-- Products Tab -->
            <div id="products" class="tab-content">
                <!-- Visual Product Editor -->
                <div class="visual-editor-container">
                    <!-- Filter Controls -->
                    <div class="editor-controls">
                        <div class="control-row">
                            <div class="control-group">
                                <label>Component Type:</label>
                                <select id="categorySelect" onchange="onCategoryChange()">
                                    <option value="">Select Category</option>
                                </select>
                            </div>
                            
                            <div class="control-group">
                                <label>Store:</label>
                                <select id="storeSelect" onchange="onStoreChange()">
                                    <option value="all">All Stores</option>
                                </select>
                            </div>
                            
                            <div class="control-group">
                                <label>Search:</label>
                                <input type="text" id="searchInput" placeholder="Search products..." onkeyup="applyStatusFilter()">
                            </div>
                        </div>
                        
                        <!-- Status Filters -->
                        <div class="status-filters">
                            <button class="status-btn" id="unedited-btn" onclick="setStatus('unedited')">
                                <span>üî¥ Unedited</span>
                                <span class="count" id="unedited-count">0</span>
                            </button>
                            <button class="status-btn" id="completed-btn" onclick="setStatus('completed')">
                                <span>‚úÖ Completed</span>
                                <span class="count" id="completed-count">0</span>
                            </button>
                            <button class="status-btn active" id="all-btn" onclick="setStatus('all')">
                                <span>üì¶ All</span>
                                <span class="count" id="all-count">0</span>
                            </button>
                            <button class="btn btn-secondary" id="bulk-edit-toggle" onclick="toggleBulkEdit()">
                                üìã Bulk Edit
                            </button>
                        </div>
                        
                        <!-- Bulk Actions Toolbar -->
                        <div id="bulk-actions-toolbar" class="bulk-actions-toolbar" style="display: none;">
                            <div class="bulk-selection-info">
                                <span id="selected-count">0</span> products selected
                                <button class="btn btn-sm btn-secondary" onclick="selectAllVisible()">Select All Visible</button>
                                <button class="btn btn-sm btn-secondary" onclick="selectAllUnedited()">Select Unedited</button>
                                <button class="btn btn-sm btn-secondary" onclick="clearSelection()">Clear Selection</button>
                            </div>
                            <div class="bulk-actions">
                                <button class="btn btn-primary" onclick="openBulkSpecModal()">Apply Specs to Selected</button>
                                <button class="btn btn-warning" onclick="bulkChangeCategory()">Change Category</button>
                                <button class="btn btn-success" onclick="bulkMarkCompleted()">Mark as Completed</button>
                            </div>
                        </div>
                        
                        <!-- Category Info -->
                        <div id="categoryInfo" class="category-info"></div>
                    </div>
                    
                    <!-- Product Grid -->
                    <div id="productGrid" class="product-grid">
                        <div class="empty-state">
                            <h3>üì¶ Select a Component Type</h3>
                            <p>Choose a category from the dropdown above to start editing product compatibility specs</p>
                        </div>
                    </div>
                    
                    <!-- Product Editor Modal -->
                    <div id="productModal" class="product-modal" style="display: none;">
                        <div class="modal-content">
                            <div class="modal-header">
                                <h3 id="modalProductTitle">Edit Product</h3>
                                <button class="close-btn" onclick="closeProductModal()">&times;</button>
                            </div>
                            
                            <div class="modal-body">
                                <div class="product-preview">
                                    <img id="modalProductImage" src="" alt="Product Image">
                                    <div class="product-details">
                                        <h4 id="modalProductName">Product Name</h4>
                                        <p id="modalProductPrice">Price</p>
                                        <p id="modalProductStore">Store</p>
                                    </div>
                                </div>
                                
                                <div class="specs-form">
                                    <h4>Compatibility Specifications</h4>
                                    <div id="specsContainer">
                                        <!-- Dynamic spec fields will be inserted here -->
                                    </div>
                                    
                                    <div class="category-change">
                                        <label>Change Category:</label>
                                        <select id="newCategorySelect">
                                            <option value="">Keep current category</option>
                                        </select>
                                    </div>
                                </div>
                            </div>
                            
                            <div class="modal-footer">
                                <button class="btn btn-success" onclick="saveProductSpecs()">Save Changes</button>
                                <button class="btn btn-warning" onclick="clearSpecs()">Clear All Specs</button>
                                <button class="btn btn-secondary" onclick="closeProductModal()">Cancel</button>
                                
                                <!-- Navigation -->
                                <div class="navigation-controls">
                                    <button class="btn btn-primary" onclick="previousProduct()">‚Üê Previous</button>
                                    <span id="productPosition">1 of 100</span>
                                    <button class="btn btn-primary" onclick="nextProduct()">Next ‚Üí</button>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Bulk Spec Modal -->
                    <div id="bulkSpecModal" class="bulk-spec-modal" style="display: none;">
                        <div class="bulk-spec-content">
                            <div class="modal-header">
                                <h3>Apply Specs to Multiple Products</h3>
                                <button class="close-btn" onclick="closeBulkSpecModal()">&times;</button>
                            </div>
                            
                            <div class="modal-body">
                                <div class="bulk-preview">
                                    <h4>Selected Products (<span id="bulk-product-count">0</span>)</h4>
                                    <div id="bulk-product-list">
                                        <!-- Selected products will be listed here -->
                                    </div>
                                </div>
                                
                                <div class="specs-form">
                                    <h4>Apply Specifications</h4>
                                    <div id="bulk-specs-container">
                                        <!-- Dynamic spec fields will be inserted here -->
                                    </div>
                                </div>
                            </div>
                            
                            <div class="modal-footer">
                                <button class="btn btn-success" onclick="applyBulkSpecs()">Apply to All Selected</button>
                                <button class="btn btn-warning" onclick="clearBulkSpecs()">Clear All Specs</button>
                                <button class="btn btn-secondary" onclick="closeBulkSpecModal()">Cancel</button>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            
            <!-- Logs Tab -->
            <div id="logs" class="tab-content">
                <div class="control-group">
                    <h4>üìã System Logs</h4>
                    <button class="btn btn-primary" onclick="refreshLogs()">Refresh Logs</button>
                    <button class="btn btn-warning" onclick="clearLogs()">Clear Logs</button>
                    <button class="btn btn-success" onclick="downloadLogs()">Download Logs</button>
                </div>
                
                <div class="log-area" id="system-logs">
                    <div id="system-log-content">üìã System logs will appear here...\n</div>
                </div>
            </div>
        </div>
    </div>
    
    <script>
        // API Base URL
        const API_BASE = 'http://localhost:8000';
        
        // Current scraping status
        let scrapingInProgress = false;
        
        // Initialize dashboard
        document.addEventListener('DOMContentLoaded', function() {
            refreshStatus();
            loadSiteCards();
            setInterval(refreshStatus, 30000); // Refresh every 30 seconds
        });
        
        // Tab Management
        function showTab(tabName) {
            // Hide all tabs
            const tabs = document.querySelectorAll('.tab-content');
            tabs.forEach(tab => tab.classList.remove('active'));
            
            // Remove active from all tab buttons
            const tabButtons = document.querySelectorAll('.tab');
            tabButtons.forEach(btn => btn.classList.remove('active'));
            
            // Show selected tab
            document.getElementById(tabName).classList.add('active');
            event.target.classList.add('active');
            
            // Load tab-specific content
            if (tabName === 'products') {
                if (!allProductsData.sites) {
                    loadProductsData();
                }
            } else if (tabName === 'logs') {
                refreshLogs();
            }
        }
        
        // Status Management
        async function refreshStatus() {
            try {
                const response = await fetch(`${API_BASE}/status`);
                const data = await response.json();
                
                document.getElementById('total-products').textContent = data.total_products || 0;
                document.getElementById('active-sites').textContent = Object.keys(data.sites || {}).length;
                
                // Calculate hours since last update
                if (data.last_updated && data.last_updated !== 'Never') {
                    const lastUpdate = new Date(data.last_updated);
                    const now = new Date();
                    const hoursDiff = Math.round((now - lastUpdate) / (1000 * 60 * 60));
                    document.getElementById('last-update').textContent = hoursDiff;
                } else {
                    document.getElementById('last-update').textContent = 'Never';
                }
                
                // Update site cards if they exist
                updateSiteCards(data.sites);
                
            } catch (error) {
                console.error('Failed to refresh status:', error);
                document.getElementById('server-status').innerHTML = '<span class="status-indicator status-offline"></span>Offline';
            }
        }
        
        // Site Cards Management
        function loadSiteCards() {
            const sites = [
                {name: 'globaliraq', display: 'GlobalIraq', logo: '/WebSitesLogo/globaliraq.svg'},
                {name: 'alityan', display: 'Alityan', logo: '/WebSitesLogo/alityan.svg'},
                {name: 'kolshzin', display: 'Kolshzin', logo: '/WebSitesLogo/kolshzin.svg'},
                {name: '3d-iraq', display: '3D-Iraq', logo: '/WebSitesLogo/3d-iraq.svg'},
                {name: 'jokercenter', display: 'JokerCenter', logo: '/WebSitesLogo/jokercenter.webp'},
                {name: 'galaxyiq', display: 'Galaxy IQ', logo: 'WebSitesLogo/galaxyiq.png'},
                {name: 'almanjam', display: 'Almanjam', logo: '/WebSitesLogo/almanjam.png'},
                {name: 'spniq', display: 'SpiderNet', logo: '/WebSitesLogo/SpiderNet.svg'},
                {name: 'altajit', display: 'AlTajit', logo: '/WebSitesLogo/altajit.png'}
            ];
            
            const grid = document.getElementById('site-grid');
            grid.innerHTML = '';
            
            sites.forEach(site => {
                const card = document.createElement('div');
                card.className = 'site-card';
                
                // Check if site logo is an image path or text
                const logoContent = site.logo.includes('/') 
                    ? `<img src="${site.logo}" alt="${site.display}" onerror="this.parentElement.innerHTML='${site.display.substring(0,2)}'">`
                    : site.logo;
                
                card.innerHTML = `
                    <div class="site-logo">${logoContent}</div>
                    <h5>${site.display}</h5>
                    <p id="${site.name}-count">Loading...</p>
                    <p id="${site.name}-status">Checking...</p>
                    ${site.name === 'galaxyiq' 
                        ? '<span class="btn btn-secondary btn-sm" style="cursor: default; opacity: 0.7;">üìù Manual Scrape</span>'
                        : `<button class="btn btn-primary btn-sm" onclick="scrapeSingleSite('${site.name}')">Scrape Now</button>`
                    }
                `;
                grid.appendChild(card);
            });
        }
        
        function updateSiteCards(sites) {
            if (!sites) return;
            
            Object.keys(sites).forEach(siteName => {
                const siteData = sites[siteName];
                const countElement = document.getElementById(`${siteName}-count`);
                const statusElement = document.getElementById(`${siteName}-status`);
                
                if (countElement) {
                    countElement.textContent = `${siteData.product_count || 0} products`;
                }
                
                if (statusElement) {
                    const lastUpdate = siteData.last_updated;
                    if (lastUpdate && lastUpdate !== 'Never') {
                        const updateDate = new Date(lastUpdate);
                        const now = new Date();
                        const hoursDiff = Math.round((now - updateDate) / (1000 * 60 * 60));
                        statusElement.textContent = `${hoursDiff}h ago`;
                    } else {
                        statusElement.textContent = 'Never updated';
                    }
                }
            });
        }
        
        // Scraping Functions
        async function scrapeAllSites() {
            if (scrapingInProgress) {
                alert('Scraping already in progress!');
                return;
            }
            
            scrapingInProgress = true;
            const logContent = document.getElementById('log-content');
            logContent.innerHTML += 'üîÑ Starting full scrape of all retailers...\n';
            
            try {
                const response = await fetch(`${API_BASE}/scrape`, {method: 'POST'});
                const result = await response.json();
                
                if (result.status === 'success') {
                    logContent.innerHTML += '‚úÖ All sites scraped successfully!\n';
                    refreshStatus();
                } else {
                    logContent.innerHTML += `‚ùå Scraping failed: ${result.message}\n`;
                }
            } catch (error) {
                logContent.innerHTML += `‚ùå Error: ${error.message}\n`;
            }
            
            scrapingInProgress = false;
            logContent.scrollTop = logContent.scrollHeight;
        }
        
        async function scrapeSingleSite(siteName) {
            const logContent = document.getElementById('log-content');
            logContent.innerHTML += `üîÑ Scraping ${siteName}...\n`;
            
            try {
                const response = await fetch(`${API_BASE}/scrape/${siteName}`, {method: 'POST'});
                const result = await response.json();
                
                if (result.status === 'success') {
                    logContent.innerHTML += `‚úÖ ${siteName} scraped successfully!\n`;
                    refreshStatus();
                } else {
                    logContent.innerHTML += `‚ùå ${siteName} failed: ${result.message}\n`;
                }
            } catch (error) {
                logContent.innerHTML += `‚ùå ${siteName} error: ${error.message}\n`;
            }
            
            logContent.scrollTop = logContent.scrollHeight;
        }
        
        // Visual Product Editor Variables
        let allProductsData = {};
        let allCategoryProducts = [];
        let currentProducts = [];
        let currentComponentType = '';
        let currentStatus = 'all';
        let currentIndex = 0;
        let currentProduct = null;
        
        // Bulk Edit Variables
        let selectedProducts = new Set();
        let bulkEditMode = false;
        
        // PC Builder categories only
        const pcBuilderCategories = ['CPU', 'GPU', 'Motherboards', 'RAM', 'Power Supply', 'Cooler', 'Storage', 'Monitor', 'Case', 'Mouse', 'Keyboard', 'Headset', 'Fans', 'Thermals', 'Laptops'];
        
        // Spec field templates for each category
        const specTemplates = {
            CPU: [
                { name: 'socket', label: 'Socket', type: 'select', options: ['LGA1851', 'LGA1700', 'LGA1200', 'LGA1151', 'LGA2066', 'AM4', 'AM5', 'TR4', 'sTRX4'] },
                { name: 'tdp', label: 'TDP (W)', type: 'number', min: 15, max: 300 }
            ],
            GPU: [
                { name: 'recommended_psu', label: 'Recommended PSU (W)', type: 'select', options: [400, 450, 500, 550, 600, 650, 700, 750, 800, 850, 1000, 1200, 1250, 1300, 1500, 1600] }
            ],
            Motherboards: [
                { name: 'socket', label: 'Socket', type: 'select', options: ['LGA1851', 'LGA1700', 'LGA1200', 'AM4', 'AM5', 'TR4', 'sTRX4'] },
                { name: 'ram_type', label: 'RAM Type', type: 'select', options: ['DDR4', 'DDR5'] }
            ],
            RAM: [
                { name: 'memory_type', label: 'Memory Type', type: 'select', options: ['DDR4', 'DDR5'] }
            ],
            'Power Supply': [
                { name: 'wattage', label: 'Wattage', type: 'select', options: [400, 450, 500, 550, 600, 650, 700, 750, 800, 850, 1000, 1050, 1100, 1200, 1250, 1300, 1500, 1600] }
            ],
            Cooler: [],
            Storage: [],
            Monitor: [],
            Case: [],
            Mouse: [],
            Keyboard: [],
            Headset: []
        };
        
        // Load products data from backend
        async function loadProductsData() {
            try {
                const response = await fetch(`${API_BASE}/status`);
                const data = await response.json();
                
                // Get full products data
                const fullResponse = await fetch(`${API_BASE}/products`);
                if (!fullResponse.ok) {
                    throw new Error('Failed to load products data');
                }
                
                allProductsData = await fullResponse.json();
                
                // Initialize dropdowns
                initializeCategoryDropdown();
                initializeStoreDropdown();
                
                console.log('‚úÖ Products data loaded:', allProductsData.total_products || 0, 'total products');
                return true;
            } catch (error) {
                console.error('‚ùå Failed to load products:', error);
                return false;
            }
        }
        
        // Initialize category dropdown
        function initializeCategoryDropdown() {
            const categorySelect = document.getElementById('categorySelect');
            const newCategorySelect = document.getElementById('newCategorySelect');
            
            categorySelect.innerHTML = '<option value="">Select Category</option>';
            newCategorySelect.innerHTML = '<option value="">Keep current category</option>';
            
            // Find available categories in the data
            const availableCategories = new Set();
            
            if (allProductsData.sites) {
                for (const siteName in allProductsData.sites) {
                    const siteData = allProductsData.sites[siteName];
                    if (siteData.products) {
                        siteData.products.forEach(product => {
                            if (product.category && pcBuilderCategories.includes(product.category)) {
                                availableCategories.add(product.category);
                            }
                        });
                    }
                }
            }
            
            // Add categories to dropdowns
            pcBuilderCategories.filter(cat => availableCategories.has(cat)).forEach(category => {
                const option1 = document.createElement('option');
                option1.value = category;
                option1.textContent = category;
                categorySelect.appendChild(option1);
                
                const option2 = document.createElement('option');
                option2.value = category;
                option2.textContent = category;
                newCategorySelect.appendChild(option2);
            });
        }
        
        // Initialize store dropdown
        function initializeStoreDropdown() {
            const storeSelect = document.getElementById('storeSelect');
            storeSelect.innerHTML = '<option value="all">All Stores</option>';
            
            if (allProductsData.sites) {
                Object.keys(allProductsData.sites).forEach(siteName => {
                    const option = document.createElement('option');
                    option.value = siteName;
                    option.textContent = siteName.charAt(0).toUpperCase() + siteName.slice(1);
                    storeSelect.appendChild(option);
                });
            }
        }
        
        // Category change handler
        function onCategoryChange() {
            const selectedCategory = document.getElementById('categorySelect').value;
            
            if (!selectedCategory) {
                document.getElementById('productGrid').innerHTML = `
                    <div class="empty-state">
                        <h3>üì¶ Select a Component Type</h3>
                        <p>Choose a category from the dropdown above to start editing product compatibility specs</p>
                    </div>
                `;
                return;
            }
            
            currentComponentType = selectedCategory;
            loadCategoryProducts();
        }
        
        // Store change handler
        function onStoreChange() {
            if (currentComponentType) {
                applyFilters();
            }
        }
        
        // Load products for selected category
        function loadCategoryProducts() {
            allCategoryProducts = [];
            
            if (!allProductsData.sites) return;
            
            // Collect all products from selected category
            for (const siteName in allProductsData.sites) {
                const siteData = allProductsData.sites[siteName];
                if (siteData.products) {
                    siteData.products.forEach(product => {
                        if (product.category === currentComponentType) {
                            product._siteName = siteName; // Add site info
                            allCategoryProducts.push(product);
                        }
                    });
                }
            }
            
            console.log(`üì¶ Loaded ${allCategoryProducts.length} products for ${currentComponentType}`);
            applyFilters();
        }
        
        // Apply all filters
        function applyFilters() {
            const storeFilter = document.getElementById('storeSelect').value;
            const searchTerm = document.getElementById('searchInput').value.toLowerCase();
            
            // Start with all category products
            let filteredProducts = [...allCategoryProducts];
            
            // Apply store filter
            if (storeFilter !== 'all') {
                filteredProducts = filteredProducts.filter(product => product._siteName === storeFilter);
            }
            
            // Apply search filter
            if (searchTerm) {
                filteredProducts = filteredProducts.filter(product => 
                    product.title.toLowerCase().includes(searchTerm)
                );
            }
            
            // Apply status filter
            const template = specTemplates[currentComponentType] || [];
            filteredProducts = filteredProducts.filter(product => {
                const specs = product.compatibility_specs;
                let actualSpecCount = specs ? Object.keys(specs).filter(key => specs[key] !== null && specs[key] !== undefined && specs[key] !== '').length : 0;
                
                switch (currentStatus) {
                    case 'unedited':
                        return !specs || actualSpecCount === 0;
                    case 'completed':
                        return actualSpecCount >= Math.max(template.length, 1);
                    default:
                        return true;
                }
            });
            
            currentProducts = filteredProducts;
            updateCounts();
            displayProducts();
        }
        
        // Update status filter counts
        function updateCounts() {
            const template = specTemplates[currentComponentType] || [];
            let unedited = 0, completed = 0;
            
            allCategoryProducts.forEach(product => {
                const specs = product.compatibility_specs;
                let actualSpecCount = specs ? Object.keys(specs).filter(key => specs[key] !== null && specs[key] !== undefined && specs[key] !== '').length : 0;
                
                if (actualSpecCount === 0) {
                    unedited++;
                } else if (actualSpecCount >= Math.max(template.length, 1)) {
                    completed++;
                }
            });
            
            document.getElementById('unedited-count').textContent = unedited;
            document.getElementById('completed-count').textContent = completed;
            document.getElementById('all-count').textContent = allCategoryProducts.length;
            
            // Update category info
            updateCategoryInfo();
        }
        
        // Update category info display
        function updateCategoryInfo() {
            const info = document.getElementById('categoryInfo');
            const badges = [];
            
            if (currentComponentType) {
                badges.push(`Component: ${currentComponentType}`);
            }
            
            const selectedStore = document.getElementById('storeSelect').value;
            if (selectedStore !== 'all') {
                badges.push(`Store: ${selectedStore.charAt(0).toUpperCase() + selectedStore.slice(1)}`);
            }
            
            const searchTerm = document.getElementById('searchInput').value;
            if (searchTerm) {
                badges.push(`Search: "${searchTerm}"`);
            }
            
            if (currentProducts.length > 0) {
                badges.push(`Showing: ${currentProducts.length} products`);
            }
            
            info.innerHTML = badges.map(badge => `<span class="filter-badge">${badge}</span>`).join('');
        }
        
        // Set status filter
        function setStatus(status) {
            // Update button states
            document.querySelectorAll('.status-btn').forEach(btn => btn.classList.remove('active'));
            document.getElementById(`${status}-btn`).classList.add('active');
            
            currentStatus = status;
            applyFilters();
        }
        
        // Display products in grid
        function displayProducts() {
            const grid = document.getElementById('productGrid');
            
            if (currentProducts.length === 0) {
                grid.innerHTML = `
                    <div class="empty-state">
                        <h3>üîç No Products Found</h3>
                        <p>Try adjusting your filters or search terms</p>
                    </div>
                `;
                return;
            }
            
            grid.innerHTML = currentProducts.map((product, index) => {
                const specs = product.compatibility_specs;
                const hasSpecs = specs && Object.keys(specs).length > 0;
                const imageUrl = getProductImageUrl(product);
                
                const productId = `${product.id}-${product._siteName}`;
                const isSelected = selectedProducts.has(productId);
                
                return `
                    <div class="product-item ${hasSpecs ? 'has-specs' : 'no-specs'} ${bulkEditMode ? 'bulk-mode' : ''} ${isSelected ? 'bulk-selected' : ''}" 
                         onclick="${bulkEditMode ? `toggleProductSelection(${index}, event)` : `openProductModal(${index})`}">
                        ${bulkEditMode ? `
                            <input type="checkbox" class="bulk-checkbox" ${isSelected ? 'checked' : ''} 
                                   onchange="toggleProductSelection(${index}, event)" onclick="event.stopPropagation()">
                            <div class="bulk-overlay"></div>
                        ` : ''}
                        <img class="product-image" src="${imageUrl}" alt="Product Image" onerror="this.src='data:image/svg+xml,%3Csvg width=&quot;100%25&quot; height=&quot;100%25&quot; viewBox=&quot;0 0 80 80&quot; fill=&quot;none&quot; xmlns=&quot;http://www.w3.org/2000/svg&quot;%3E%3Crect width=&quot;80&quot; height=&quot;80&quot; fill=&quot;%23f8f9fa&quot;/%3E%3Crect x=&quot;15&quot; y=&quot;20&quot; width=&quot;50&quot; height=&quot;25&quot; rx=&quot;4&quot; fill=&quot;%23dee2e6&quot;/%3E%3Ccircle cx=&quot;25&quot; cy=&quot;30&quot; r=&quot;5&quot; fill=&quot;%23adb5bd&quot;/%3E%3Ctext x=&quot;40&quot; y=&quot;60&quot; dominant-baseline=&quot;middle&quot; text-anchor=&quot;middle&quot; font-size=&quot;12&quot; font-weight=&quot;bold&quot; fill=&quot;%23677289&quot;%3ENo Image%3C/text%3E%3C/svg%3E'">
                        <div class="product-title">${product.title}</div>
                        <div class="product-price">${formatPrice(product.price)} ${product.detected_currency || 'IQD'}</div>
                        <div class="product-store">${product._siteName}</div>
                        <div class="product-status">
                            <span class="status-indicator ${hasSpecs ? 'status-complete' : 'status-incomplete'}"></span>
                            <span>${hasSpecs ? 'Has specs' : 'No specs'}</span>
                        </div>
                    </div>
                `;
            }).join('');
        }
        
        // Get product image URL
        function getProductImageUrl(product) {
            const fallbackImage = 'data:image/svg+xml;base64,PHN2ZyB3aWR0aD0iNTAiIGhlaWdodD0iNTAiIHZpZXdCb3g9IjAgMCA1MCA1MCIgZmlsbD0ibm9uZSIgeG1sbnM9Imh0dHA6Ly93d3cudzMub3JnLzIwMDAvc3ZnIj4KPHJlY3Qgd2lkdGg9IjUwIiBoZWlnaHQ9IjUwIiBmaWxsPSIjZjhmOWZhIi8+CjwvZz4KPC9zdmc+';
            
            // Debug: Log product data for problematic stores
            if (product._siteName === 'globaliraq' || product._siteName === 'alityan') {
                console.log(`üîç Debugging ${product._siteName} product:`, {
                    title: product.title,
                    image: product.image,
                    imageUrl: product.imageUrl,
                    image_url: product.image_url,
                    img: product.img,
                    images: product.images,
                    allFields: Object.keys(product)
                });
            }
            
            // Try different image field variations used by different scrapers
            let imageUrl = null;
            
            // Handle Shopify image object (GlobalIraq, Alityan)
            if (product.image && typeof product.image === 'object' && product.image.src) {
                imageUrl = product.image.src;
            } 
            // Handle direct URL strings
            else if (typeof product.image === 'string') {
                imageUrl = product.image;
            }
            // Try other field variations
            else {
                imageUrl = product.imageUrl ||         // Some scrapers use this
                          product.image_url ||        // Snake case variant
                          product.img ||              // Short variant
                          null;
            }
            
            // Handle array format
            if (!imageUrl && Array.isArray(product.images) && product.images.length > 0) {
                const firstImage = product.images[0];
                if (typeof firstImage === 'object' && firstImage.src) {
                    imageUrl = firstImage.src;
                } else if (typeof firstImage === 'string') {
                    imageUrl = firstImage;
                }
            }
            
            // Return placeholder if no valid image found
            if (!imageUrl || (typeof imageUrl === 'string' && imageUrl.trim() === '')) {
                return 'data:image/svg+xml,%3Csvg width="100%" height="100%" viewBox="0 0 80 80" fill="none" xmlns="http://www.w3.org/2000/svg"%3E%3Crect width="80" height="80" fill="%23f8f9fa"/%3E%3Crect x="15" y="20" width="50" height="25" rx="4" fill="%23dee2e6"/%3E%3Ccircle cx="25" cy="30" r="5" fill="%23adb5bd"/%3E%3Ctext x="40" y="60" dominant-baseline="middle" text-anchor="middle" font-size="12" font-weight="bold" fill="%23677289"%3ENo Image%3C/text%3E%3C/svg%3E';
            }
            
            // Handle relative URLs - make them absolute
            if (imageUrl && imageUrl !== fallbackImage && typeof imageUrl === 'string') {
                try {
                    const originalUrl = imageUrl;
                    
                    // Check if it's a relative URL and prepend appropriate base URL
                    if (imageUrl.startsWith('//')) {
                        imageUrl = 'https:' + imageUrl;
                    } else if (imageUrl.startsWith('/') && !imageUrl.startsWith('//')) {
                        // Relative path - determine base URL from store
                        const storeName = product._siteName || product.store;
                        if (storeName === 'globaliraq') {
                            imageUrl = 'https://globaliraq.net' + imageUrl;
                        } else if (storeName === 'alityan') {
                            imageUrl = 'https://alityan.com' + imageUrl;
                        } else if (storeName === 'kolshzin') {
                            imageUrl = 'https://kolshzin.com' + imageUrl;
                        }
                        // Add other stores as needed
                    }
                    
                    if (product._siteName === 'globaliraq' || product._siteName === 'alityan') {
                        console.log(`üîó Image URL processing for ${product._siteName}:`, {
                            original: originalUrl,
                            processed: imageUrl
                        });
                    }
                    
                } catch (e) {
                    console.error('Error processing image URL:', e);
                    imageUrl = fallbackImage;
                }
            }
            
            return imageUrl;
        }
        
        // Format price with commas
        function formatPrice(price) {
            if (!price) return '0';
            return Number(price).toLocaleString();
        }
        
        // Open product editor modal
        function openProductModal(index) {
            currentIndex = index;
            currentProduct = currentProducts[index];
            
            if (!currentProduct) return;
            
            // Update modal content
            document.getElementById('modalProductTitle').textContent = 'Edit Product Specifications';
            document.getElementById('modalProductName').innerHTML = `<a href="${currentProduct.link}" target="_blank" rel="noopener noreferrer" style="color: #4facfe; text-decoration: none; hover: text-decoration: underline;">${currentProduct.title}</a>`;
            document.getElementById('modalProductPrice').textContent = `${formatPrice(currentProduct.price)} ${currentProduct.detected_currency || 'IQD'}`;
            document.getElementById('modalProductStore').textContent = currentProduct._siteName;
            const modalImg = document.getElementById('modalProductImage');
            modalImg.src = getProductImageUrl(currentProduct);
            modalImg.onerror = () => { 
                modalImg.src = 'data:image/svg+xml,%3Csvg width="100%" height="100%" viewBox="0 0 80 80" fill="none" xmlns="http://www.w3.org/2000/svg"%3E%3Crect width="80" height="80" fill="%23f8f9fa"/%3E%3Crect x="15" y="20" width="50" height="25" rx="4" fill="%23dee2e6"/%3E%3Ccircle cx="25" cy="30" r="5" fill="%23adb5bd"/%3E%3Ctext x="40" y="60" dominant-baseline="middle" text-anchor="middle" font-size="12" font-weight="bold" fill="%23677289"%3ENo Image%3C/text%3E%3C/svg%3E'; 
            };
            document.getElementById('productPosition').textContent = `${index + 1} of ${currentProducts.length}`;
            
            // Generate spec fields
            generateSpecFields();
            
            // Show modal
            document.getElementById('productModal').style.display = 'flex';
        }
        
        // Generate spec input fields
        function generateSpecFields() {
            const container = document.getElementById('specsContainer');
            const template = specTemplates[currentComponentType] || [];
            const existingSpecs = currentProduct.compatibility_specs || {};
            
            if (template.length === 0) {
                container.innerHTML = '<p style="color: #6c757d; text-align: center; padding: 20px;">No specifications required for this category</p>';
                return;
            }
            
            container.innerHTML = template.map(field => {
                const currentValue = existingSpecs[field.name] || '';
                
                if (field.type === 'select') {
                    const options = field.options.map(option => 
                        `<option value="${option}" ${currentValue == option ? 'selected' : ''}>${option}</option>`
                    ).join('');
                    
                    return `
                        <div class="spec-field">
                            <label>${field.label}:</label>
                            <select data-field="${field.name}">
                                <option value="">Select ${field.label}</option>
                                ${options}
                            </select>
                        </div>
                    `;
                } else if (field.type === 'number') {
                    return `
                        <div class="spec-field">
                            <label>${field.label}:</label>
                            <input type="number" data-field="${field.name}" value="${currentValue}" 
                                   min="${field.min || 0}" max="${field.max || 9999}" placeholder="Enter ${field.label}">
                        </div>
                    `;
                }
            }).join('');
        }
        
        // Save product specifications
        async function saveProductSpecs() {
            if (!currentProduct) return;
            
            // Collect spec data
            const specFields = document.querySelectorAll('#specsContainer [data-field]');
            const specs = {};
            
            specFields.forEach(field => {
                const fieldName = field.getAttribute('data-field');
                const value = field.value.trim();
                if (value) {
                    specs[fieldName] = field.type === 'number' ? Number(value) : value;
                }
            });
            
            // Get category change
            const newCategory = document.getElementById('newCategorySelect').value;
            
            const saveData = {
                product_id: currentProduct.id,
                site_name: currentProduct._siteName,
                compatibility_specs: Object.keys(specs).length > 0 ? specs : null
            };
            
            if (newCategory) {
                saveData.category = newCategory;
                saveData.manual_category = newCategory;
                saveData.original_category = currentProduct.category;
            }
            
            try {
                const response = await fetch(`${API_BASE}/save-single-spec`, {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify(saveData)
                });
                
                const result = await response.json();
                
                if (result.status === 'success') {
                    // Update local data
                    if (Object.keys(specs).length > 0) {
                        currentProduct.compatibility_specs = specs;
                    } else {
                        delete currentProduct.compatibility_specs;
                    }
                    
                    if (newCategory) {
                        currentProduct.category = newCategory;
                    }
                    
                    // Refresh display
                    applyFilters();
                    
                    // Move to next product
                    nextProduct();
                } else {
                    alert(`Failed to save: ${result.message}`);
                }
            } catch (error) {
                alert(`Error: ${error.message}`);
            }
        }
        
        // Clear all specs
        function clearSpecs() {
            document.querySelectorAll('#specsContainer [data-field]').forEach(field => {
                field.value = '';
            });
        }
        
        // Close modal
        function closeProductModal() {
            document.getElementById('productModal').style.display = 'none';
        }
        
        // Navigate to previous product
        function previousProduct() {
            if (currentIndex > 0) {
                openProductModal(currentIndex - 1);
            }
        }
        
        // Navigate to next product
        function nextProduct() {
            if (currentIndex < currentProducts.length - 1) {
                openProductModal(currentIndex + 1);
            } else {
                closeProductModal();
            }
        }
        
        // Apply status filter (for search input)
        function applyStatusFilter() {
            applyFilters();
        }
        
        // ============ BULK EDIT FUNCTIONS ============
        
        // Toggle bulk edit mode
        function toggleBulkEdit() {
            bulkEditMode = !bulkEditMode;
            const toggleBtn = document.getElementById('bulk-edit-toggle');
            const toolbar = document.getElementById('bulk-actions-toolbar');
            
            if (bulkEditMode) {
                toggleBtn.textContent = '‚ùå Exit Bulk Edit';
                toggleBtn.classList.remove('btn-secondary');
                toggleBtn.classList.add('btn-danger');
                toolbar.style.display = 'flex';
            } else {
                toggleBtn.textContent = 'üìã Bulk Edit';
                toggleBtn.classList.remove('btn-danger');
                toggleBtn.classList.add('btn-secondary');
                toolbar.style.display = 'none';
                clearSelection();
            }
            
            // Refresh display to show/hide checkboxes
            displayProducts();
        }
        
        // Toggle product selection
        function toggleProductSelection(index, event) {
            if (event) event.stopPropagation();
            
            const product = currentProducts[index];
            const productId = `${product.id}-${product._siteName}`;
            
            if (selectedProducts.has(productId)) {
                selectedProducts.delete(productId);
            } else {
                selectedProducts.add(productId);
            }
            
            updateSelectionUI();
            displayProducts(); // Refresh to update visual state
        }
        
        // Update selection UI
        function updateSelectionUI() {
            const count = selectedProducts.size;
            document.getElementById('selected-count').textContent = count;
            
            // Enable/disable bulk action buttons
            const bulkActionBtns = document.querySelectorAll('#bulk-actions-toolbar .bulk-actions .btn');
            bulkActionBtns.forEach(btn => {
                btn.disabled = count === 0;
            });
        }
        
        // Select all visible products
        function selectAllVisible() {
            currentProducts.forEach(product => {
                const productId = `${product.id}-${product._siteName}`;
                selectedProducts.add(productId);
            });
            updateSelectionUI();
            displayProducts();
        }
        
        // Select all unedited products
        function selectAllUnedited() {
            const template = specTemplates[currentComponentType] || [];
            
            currentProducts.forEach(product => {
                const specs = product.compatibility_specs;
                let actualSpecCount = specs ? Object.keys(specs).filter(key => specs[key] !== null && specs[key] !== undefined && specs[key] !== '').length : 0;
                
                if (actualSpecCount === 0) {
                    const productId = `${product.id}-${product._siteName}`;
                    selectedProducts.add(productId);
                }
            });
            updateSelectionUI();
            displayProducts();
        }
        
        // Clear selection
        function clearSelection() {
            selectedProducts.clear();
            updateSelectionUI();
            displayProducts();
        }
        
        // Open bulk spec modal
        function openBulkSpecModal() {
            if (selectedProducts.size === 0) {
                alert('Please select products first');
                return;
            }
            
            // Update product count
            document.getElementById('bulk-product-count').textContent = selectedProducts.size;
            
            // Show selected products list
            const productList = document.getElementById('bulk-product-list');
            const selectedProductsArray = currentProducts.filter(product => 
                selectedProducts.has(`${product.id}-${product._siteName}`)
            );
            
            productList.innerHTML = selectedProductsArray.map(product => 
                `<div class="bulk-preview-item">${product.title} (${product._siteName})</div>`
            ).join('');
            
            // Generate spec fields for current category
            generateBulkSpecFields();
            
            // Show modal
            document.getElementById('bulkSpecModal').style.display = 'flex';
        }
        
        // Close bulk spec modal
        function closeBulkSpecModal() {
            document.getElementById('bulkSpecModal').style.display = 'none';
        }
        
        // Generate bulk spec fields
        function generateBulkSpecFields() {
            const container = document.getElementById('bulk-specs-container');
            const template = specTemplates[currentComponentType] || [];
            
            if (template.length === 0) {
                container.innerHTML = '<p style="color: #6c757d; text-align: center; padding: 20px;">No specifications available for this category</p>';
                return;
            }
            
            container.innerHTML = template.map(field => {
                if (field.type === 'select') {
                    const options = field.options.map(option => 
                        `<option value="${option}">${option}</option>`
                    ).join('');
                    
                    return `
                        <div class="spec-field">
                            <label>${field.label}:</label>
                            <select data-field="${field.name}">
                                <option value="">Don't change</option>
                                ${options}
                            </select>
                        </div>
                    `;
                } else if (field.type === 'number') {
                    return `
                        <div class="spec-field">
                            <label>${field.label}:</label>
                            <input type="number" data-field="${field.name}" 
                                   min="${field.min || 0}" max="${field.max || 9999}" placeholder="Don't change">
                        </div>
                    `;
                }
            }).join('');
        }
        
        // Apply bulk specs
        async function applyBulkSpecs() {
            if (selectedProducts.size === 0) {
                alert('No products selected');
                return;
            }
            
            // Collect spec data
            const specFields = document.querySelectorAll('#bulk-specs-container [data-field]');
            const specs = {};
            
            specFields.forEach(field => {
                const fieldName = field.getAttribute('data-field');
                const value = field.value.trim();
                if (value && value !== "Don't change") {
                    specs[fieldName] = field.type === 'number' ? Number(value) : value;
                }
            });
            
            if (Object.keys(specs).length === 0) {
                alert('Please set at least one specification');
                return;
            }
            
            const selectedProductsArray = currentProducts.filter(product => 
                selectedProducts.has(`${product.id}-${product._siteName}`)
            );
            
            let successCount = 0;
            const totalCount = selectedProductsArray.length;
            
            // Show loading overlay
            showLoadingOverlay(`Updating ${totalCount} products...`);
            
            // Apply specs to each selected product
            for (const product of selectedProductsArray) {
                try {
                    const saveData = {
                        product_id: product.id,
                        site_name: product._siteName,
                        compatibility_specs: specs
                    };
                    
                    const response = await fetch(`${API_BASE}/save-single-spec`, {
                        method: 'POST',
                        headers: {'Content-Type': 'application/json'},
                        body: JSON.stringify(saveData)
                    });
                    
                    const result = await response.json();
                    
                    if (result.status === 'success') {
                        // Update local data
                        product.compatibility_specs = { ...(product.compatibility_specs || {}), ...specs };
                        successCount++;
                    }
                } catch (error) {
                    console.error(`Failed to update ${product.title}:`, error);
                }
            }
            
            // Hide loading overlay
            hideLoadingOverlay();
            
            console.log(`‚úÖ Successfully updated ${successCount} of ${totalCount} products!`);
            
            // Refresh display and close modal
            applyFilters();
            closeBulkSpecModal();
            clearSelection();
        }
        
        // Clear bulk specs
        function clearBulkSpecs() {
            document.querySelectorAll('#bulk-specs-container [data-field]').forEach(field => {
                field.value = '';
            });
        }
        
        // Bulk change category
        function bulkChangeCategory() {
            if (selectedProducts.size === 0) {
                alert('Please select products first');
                return;
            }
            
            // Create category selection modal
            showBulkCategoryModal();
        }
        
        // Show bulk category selection modal
        function showBulkCategoryModal() {
            const modalHtml = `
                <div id="bulkCategoryModal" class="bulk-spec-modal">
                    <div class="bulk-spec-content" style="max-width: 500px;">
                        <div class="modal-header">
                            <h3>Change Category for ${selectedProducts.size} Products</h3>
                            <button class="close-btn" onclick="closeBulkCategoryModal()">&times;</button>
                        </div>
                        
                        <div class="modal-body">
                            <div class="form-group">
                                <label>Select New Category:</label>
                                <select id="bulkCategorySelect" style="width: 100%; padding: 10px; margin-top: 10px;">
                                    <option value="">Choose category...</option>
                                    ${pcBuilderCategories.map(cat => 
                                        `<option value="${cat}" ${cat === currentComponentType ? 'selected' : ''}>${cat}</option>`
                                    ).join('')}
                                </select>
                            </div>
                            
                            <div style="margin-top: 20px; padding: 15px; background: #f8f9fa; border-radius: 6px;">
                                <h5>Selected Products:</h5>
                                <div style="max-height: 150px; overflow-y: auto;">
                                    ${currentProducts.filter(product => 
                                        selectedProducts.has(`${product.id}-${product._siteName}`)
                                    ).map(product => 
                                        `<div style="padding: 3px 0; font-size: 14px;">‚Ä¢ ${product.title} (${product._siteName})</div>`
                                    ).join('')}
                                </div>
                            </div>
                        </div>
                        
                        <div class="modal-footer">
                            <button class="btn btn-success" onclick="applyBulkCategoryChange()">Apply Category Change</button>
                            <button class="btn btn-secondary" onclick="closeBulkCategoryModal()">Cancel</button>
                        </div>
                    </div>
                </div>
            `;
            
            // Add modal to page
            document.body.insertAdjacentHTML('beforeend', modalHtml);
        }
        
        // Close bulk category modal
        function closeBulkCategoryModal() {
            const modal = document.getElementById('bulkCategoryModal');
            if (modal) modal.remove();
        }
        
        // Apply bulk category change
        async function applyBulkCategoryChange() {
            const newCategory = document.getElementById('bulkCategorySelect').value;
            
            if (!newCategory) {
                alert('Please select a category');
                return;
            }
            
            const selectedProductsArray = currentProducts.filter(product => 
                selectedProducts.has(`${product.id}-${product._siteName}`)
            );
            
            let successCount = 0;
            const totalCount = selectedProductsArray.length;
            
            // Show loading overlay
            showLoadingOverlay(`Changing category for ${totalCount} products...`);
            
            // Apply category change to each selected product
            for (const product of selectedProductsArray) {
                try {
                    const saveData = {
                        product_id: product.id,
                        site_name: product._siteName,
                        category: newCategory,
                        manual_category: newCategory,
                        original_category: product.category
                    };
                    
                    const response = await fetch(`${API_BASE}/save-single-spec`, {
                        method: 'POST',
                        headers: {'Content-Type': 'application/json'},
                        body: JSON.stringify(saveData)
                    });
                    
                    const result = await response.json();
                    
                    if (result.status === 'success') {
                        // Update local data
                        product.category = newCategory;
                        successCount++;
                    }
                } catch (error) {
                    console.error(`Failed to update category for ${product.title}:`, error);
                }
            }
            
            // Hide loading overlay
            hideLoadingOverlay();
            
            console.log(`‚úÖ Successfully changed category for ${successCount} of ${totalCount} products to ${newCategory}!`);
            
            // Refresh the category products since category changed
            if (successCount > 0) {
                loadCategoryProducts();
            }
            
            // Close modal and clear selection
            closeBulkCategoryModal();
            clearSelection();
        }
        
        // Bulk mark completed
        function bulkMarkCompleted() {
            if (selectedProducts.size === 0) {
                alert('Please select products first');
                return;
            }
            
            alert('Bulk mark completed will be implemented soon');
        }
        
        // Utility Functions
        function toggleAutoScraping() {
            alert('Auto-scraping toggle will be implemented in the next version');
        }
        
        
        function searchProducts() {
            const searchTerm = document.getElementById('search-input').value;
            alert(`Search for "${searchTerm}" will be implemented in the next version`);
        }
        
        function showLogs() {
            showTab('logs');
        }
        
        function refreshLogs() {
            const logContent = document.getElementById('system-log-content');
            logContent.innerHTML = 'üìã System logs refreshed at ' + new Date().toLocaleTimeString() + '\n';
        }
        
        function clearLogs() {
            const logContent = document.getElementById('system-log-content');
            logContent.innerHTML = 'üìã Logs cleared at ' + new Date().toLocaleTimeString() + '\n';
        }
        
        function downloadLogs() {
            alert('Log download will be implemented in the next version');
        }
        
        // Loading Overlay Functions
        function showLoadingOverlay(message = 'Loading...') {
            // Remove existing overlay if any
            hideLoadingOverlay();
            
            const overlay = document.createElement('div');
            overlay.id = 'loadingOverlay';
            overlay.style.cssText = `
                position: fixed;
                top: 0;
                left: 0;
                width: 100%;
                height: 100%;
                background: rgba(0, 0, 0, 0.7);
                display: flex;
                justify-content: center;
                align-items: center;
                z-index: 10000;
            `;
            
            overlay.innerHTML = `
                <div style="
                    background: #1e293b;
                    padding: 30px 50px;
                    border-radius: 10px;
                    text-align: center;
                    box-shadow: 0 4px 20px rgba(0,0,0,0.5);
                ">
                    <div style="
                        border: 4px solid #f3f3f3;
                        border-top: 4px solid #3b82f6;
                        border-radius: 50%;
                        width: 50px;
                        height: 50px;
                        animation: spin 1s linear infinite;
                        margin: 0 auto 20px;
                    "></div>
                    <div style="color: #fff; font-size: 16px;">${message}</div>
                </div>
            `;
            
            // Add spinner animation
            if (!document.getElementById('spinner-style')) {
                const style = document.createElement('style');
                style.id = 'spinner-style';
                style.textContent = `
                    @keyframes spin {
                        0% { transform: rotate(0deg); }
                        100% { transform: rotate(360deg); }
                    }
                `;
                document.head.appendChild(style);
            }
            
            document.body.appendChild(overlay);
        }
        
        function hideLoadingOverlay() {
            const overlay = document.getElementById('loadingOverlay');
            if (overlay) {
                overlay.remove();
            }
        }
    </script>
</body>
</html>